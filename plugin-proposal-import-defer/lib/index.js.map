{"version":3,"names":["_helperPluginUtils","require","_pluginTransformModulesCommonjs","_pluginSyntaxImportDefer","_default","exports","default","declare","api","assertVersion","t","types","template","allReferencesAreProps","scope","node","specifier","specifiers","assertImportNamespaceSpecifier","binding","getOwnBinding","local","name","referencePaths","every","path","parentPath","isMemberExpression","object","inherits","syntaxImportDefer","pre","file","defineCommonJSHook","version","getWrapperPayload","source","metadata","importNodes","needsProxy","isImportDeclaration","phase","buildRequireWrapper","init","payload","referenced","statement","ast","addHelper","wrapReference","ref","callExpression","visitor","Program","get","Error","eagerImports","Set","child","isExportNamedDeclaration","isExportAllDeclaration","value","has","add","importsToPush","push","remove","length","pushContainer","crawl"],"sources":["../src/index.ts"],"sourcesContent":["import { declare } from \"@babel/helper-plugin-utils\";\nimport type { types as t } from \"@babel/core\";\nimport type { Scope } from \"@babel/traverse\";\nimport { defineCommonJSHook } from \"@babel/plugin-transform-modules-commonjs\";\n\nimport syntaxImportDefer from \"@babel/plugin-syntax-import-defer\";\n\nexport default declare(api => {\n  api.assertVersion(\n    process.env.BABEL_8_BREAKING && process.env.IS_PUBLISH\n      ? PACKAGE_JSON.version\n      : \"^7.23.0\",\n  );\n  // We need the explicit type annotation otherwise when using t.assert* ts\n  // reports that 'Assertions require every name in the call target to be\n  // declared with an explicit type annotation'\n  const t: typeof api.types = api.types;\n  const { template } = api;\n\n  function allReferencesAreProps(scope: Scope, node: t.ImportDeclaration) {\n    const specifier = node.specifiers[0];\n    t.assertImportNamespaceSpecifier(specifier);\n\n    const binding = scope.getOwnBinding(specifier.local.name);\n    return !!binding?.referencePaths.every(path =>\n      path.parentPath.isMemberExpression({ object: path.node }),\n    );\n  }\n\n  return {\n    name: \"proposal-import-defer\",\n\n    inherits: syntaxImportDefer,\n\n    pre() {\n      const { file } = this;\n\n      defineCommonJSHook(file, {\n        name: PACKAGE_JSON.name,\n        version: PACKAGE_JSON.version,\n        getWrapperPayload(source, metadata, importNodes) {\n          let needsProxy = false;\n          for (const node of importNodes) {\n            if (!t.isImportDeclaration(node)) return null;\n            if (node.phase !== \"defer\") return null;\n            if (!allReferencesAreProps(file.scope, node)) needsProxy = true;\n          }\n          return needsProxy ? \"defer/proxy\" : \"defer/function\";\n        },\n        buildRequireWrapper(name, init, payload, referenced) {\n          if (payload === \"defer/proxy\") {\n            if (!referenced) return false;\n            return template.statement.ast`\n              var ${name} = ${file.addHelper(\"importDeferProxy\")}(\n                () => ${init}\n              )\n            `;\n          }\n          if (payload === \"defer/function\") {\n            if (!referenced) return false;\n            return template.statement.ast`\n              function ${name}(data) {\n                ${name} = () => data;\n                return data = ${init};\n              }\n            `;\n          }\n        },\n        wrapReference(ref, payload) {\n          if (payload === \"defer/function\") return t.callExpression(ref, []);\n        },\n      });\n    },\n\n    visitor: {\n      Program(path) {\n        if (this.file.get(\"@babel/plugin-transform-modules-*\") !== \"commonjs\") {\n          throw new Error(\n            `@babel/plugin-proposal-import-defer can only be used when` +\n              ` transpiling modules to CommonJS.`,\n          );\n        }\n\n        // Move all deferred imports to the end, so that in case of\n        //   import defer * as a from \"a\"\n        //   import \"b\"\n        //   import \"a\"\n        // we have the correct evaluation order\n\n        const eagerImports = new Set();\n\n        for (const child of path.get(\"body\")) {\n          if (\n            (child.isImportDeclaration() && child.node.phase == null) ||\n            (child.isExportNamedDeclaration() && child.node.source !== null) ||\n            child.isExportAllDeclaration()\n          ) {\n            const specifier = child.node.source.value;\n            if (!eagerImports.has(specifier)) {\n              eagerImports.add(specifier);\n            }\n          }\n        }\n\n        const importsToPush = [];\n        for (const child of path.get(\"body\")) {\n          if (child.isImportDeclaration({ phase: \"defer\" })) {\n            const specifier = child.node.source.value;\n            if (!eagerImports.has(specifier)) continue;\n\n            child.node.phase = null;\n            importsToPush.push(child.node);\n            child.remove();\n          }\n        }\n        if (importsToPush.length) {\n          path.pushContainer(\"body\", importsToPush);\n          // Re-collect references to moved imports\n          path.scope.crawl();\n        }\n      },\n    },\n  };\n});\n"],"mappings":"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"}