{"version":3,"names":["_helperPluginUtils","require","_pluginSyntaxPartialApplication","_core","_default","exports","default","declare","api","assertVersion","hasArgumentPlaceholder","node","arguments","some","arg","t","isArgumentPlaceholder","unwrapArguments","args","scope","init","i","length","isImmutable","id","generateUidIdentifierBasedOnNode","push","isSpreadElement","assignmentExpression","cloneNode","arrayExpression","spreadElement","argument","replacePlaceholders","placeholders","newArgs","forEach","generateUid","identifier","name","inherits","syntaxPartialApplication","visitor","CallExpression","path","functionLVal","callee","sequenceParts","argsInitializers","placeholdersParams","type","object","receiver","property","receiverLVal","memberExpression","functionExpression","isIdentifier","blockStatement","returnStatement","callExpression","replaceWith","sequenceExpression"],"sources":["../src/index.ts"],"sourcesContent":["import { declare } from \"@babel/helper-plugin-utils\";\nimport syntaxPartialApplication from \"@babel/plugin-syntax-partial-application\";\nimport { types as t } from \"@babel/core\";\nimport type { Scope } from \"@babel/traverse\";\n\nexport default declare(api => {\n  api.assertVersion(\n    process.env.BABEL_8_BREAKING && process.env.IS_PUBLISH\n      ? PACKAGE_JSON.version\n      : 7,\n  );\n\n  /**\n   * a function to figure out if a call expression has\n   * ArgumentPlaceholder as one of its arguments\n   * @param node a callExpression node\n   * @returns boolean\n   */\n  function hasArgumentPlaceholder(node: t.CallExpression) {\n    return node.arguments.some(arg => t.isArgumentPlaceholder(arg));\n  }\n\n  function unwrapArguments(\n    { arguments: args }: t.CallExpression,\n    scope: Scope,\n  ) {\n    const init: t.AssignmentExpression[] = [];\n    for (let i = 0; i < args.length; i++) {\n      const node = args[i];\n      if (!t.isArgumentPlaceholder(node) && !t.isImmutable(node)) {\n        const id = scope.generateUidIdentifierBasedOnNode(node, \"param\");\n        scope.push({ id });\n        if (t.isSpreadElement(node)) {\n          init.push(\n            t.assignmentExpression(\n              \"=\",\n              t.cloneNode(id),\n              t.arrayExpression([t.spreadElement(node.argument)]),\n            ),\n          );\n          node.argument = t.cloneNode(id);\n        } else {\n          init.push(\n            t.assignmentExpression(\n              \"=\",\n              t.cloneNode(id),\n              // @ts-expect-error Fixme: may need to handle JSXNamespacedName here\n              node,\n            ),\n          );\n          args[i] = t.cloneNode(id);\n        }\n      }\n    }\n    return init;\n  }\n\n  type CallArgsWithoutPlaceholder = Exclude<\n    t.CallExpression[\"arguments\"][number],\n    t.ArgumentPlaceholder\n  >[];\n\n  function replacePlaceholders(\n    node: t.CallExpression,\n    scope: Scope,\n  ): [t.Identifier[], CallArgsWithoutPlaceholder] {\n    const placeholders: t.Identifier[] = [];\n    const newArgs: CallArgsWithoutPlaceholder = [];\n\n    node.arguments.forEach(arg => {\n      if (t.isArgumentPlaceholder(arg)) {\n        const id = scope.generateUid(\"_argPlaceholder\");\n        placeholders.push(t.identifier(id));\n        newArgs.push(t.identifier(id));\n      } else {\n        newArgs.push(arg);\n      }\n    });\n    return [placeholders, newArgs];\n  }\n\n  return {\n    name: \"proposal-partial-application\",\n    inherits: syntaxPartialApplication,\n\n    visitor: {\n      CallExpression(path) {\n        if (!hasArgumentPlaceholder(path.node)) {\n          return;\n        }\n        const { node, scope } = path;\n        const functionLVal = path.scope.generateUidIdentifierBasedOnNode(\n          node.callee,\n        );\n        const sequenceParts = [];\n        const argsInitializers = unwrapArguments(node, scope);\n        const [placeholdersParams, args] = replacePlaceholders(node, scope);\n\n        scope.push({ id: functionLVal });\n\n        if (node.callee.type === \"MemberExpression\") {\n          const { object: receiver, property } = node.callee;\n          const receiverLVal =\n            path.scope.generateUidIdentifierBasedOnNode(receiver);\n          scope.push({ id: receiverLVal });\n\n          sequenceParts.push(\n            t.assignmentExpression(\n              \"=\",\n              t.cloneNode(receiverLVal),\n              // @ts-ignore(Babel 7 vs Babel 8) Fixme: support `super.foo(?)`\n              receiver,\n            ),\n            t.assignmentExpression(\n              \"=\",\n              t.cloneNode(functionLVal),\n              t.memberExpression(t.cloneNode(receiverLVal), property),\n            ),\n            ...argsInitializers,\n            t.functionExpression(\n              t.isIdentifier(property)\n                ? t.cloneNode(property)\n                : path.scope.generateUidIdentifierBasedOnNode(property),\n              placeholdersParams,\n              t.blockStatement(\n                [\n                  t.returnStatement(\n                    t.callExpression(\n                      t.memberExpression(\n                        t.cloneNode(functionLVal),\n                        t.identifier(\"call\"),\n                      ),\n                      [t.cloneNode(receiverLVal), ...args],\n                    ),\n                  ),\n                ],\n                [],\n              ),\n              false,\n              false,\n            ),\n          );\n        } else {\n          sequenceParts.push(\n            t.assignmentExpression(\n              \"=\",\n              t.cloneNode(functionLVal),\n              // @ts-expect-error V8 intrinsics will not support partial application\n              node.callee,\n            ),\n            ...argsInitializers,\n            t.functionExpression(\n              t.isIdentifier(node.callee)\n                ? t.cloneNode(node.callee)\n                : path.scope.generateUidIdentifierBasedOnNode(node.callee),\n              placeholdersParams,\n              t.blockStatement(\n                [\n                  t.returnStatement(\n                    t.callExpression(t.cloneNode(functionLVal), args),\n                  ),\n                ],\n                [],\n              ),\n              false,\n              false,\n            ),\n          );\n        }\n        path.replaceWith(t.sequenceExpression(sequenceParts));\n      },\n    },\n  };\n});\n"],"mappings":";;;;;;AAAA,IAAAA,kBAAA,GAAAC,OAAA;AACA,IAAAC,+BAAA,GAAAD,OAAA;AACA,IAAAE,KAAA,GAAAF,OAAA;AAAyC,IAAAG,QAAA,GAAAC,OAAA,CAAAC,OAAA,GAG1B,IAAAC,0BAAO,EAACC,GAAG,IAAI;EAC5BA,GAAG,CAACC,aAAa,CAGX,CACN,CAAC;EAQD,SAASC,sBAAsBA,CAACC,IAAsB,EAAE;IACtD,OAAOA,IAAI,CAACC,SAAS,CAACC,IAAI,CAACC,GAAG,IAAIC,WAAC,CAACC,qBAAqB,CAACF,GAAG,CAAC,CAAC;EACjE;EAEA,SAASG,eAAeA,CACtB;IAAEL,SAAS,EAAEM;EAAuB,CAAC,EACrCC,KAAY,EACZ;IACA,MAAMC,IAA8B,GAAG,EAAE;IACzC,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGH,IAAI,CAACI,MAAM,EAAED,CAAC,EAAE,EAAE;MACpC,MAAMV,IAAI,GAAGO,IAAI,CAACG,CAAC,CAAC;MACpB,IAAI,CAACN,WAAC,CAACC,qBAAqB,CAACL,IAAI,CAAC,IAAI,CAACI,WAAC,CAACQ,WAAW,CAACZ,IAAI,CAAC,EAAE;QAC1D,MAAMa,EAAE,GAAGL,KAAK,CAACM,gCAAgC,CAACd,IAAI,EAAE,OAAO,CAAC;QAChEQ,KAAK,CAACO,IAAI,CAAC;UAAEF;QAAG,CAAC,CAAC;QAClB,IAAIT,WAAC,CAACY,eAAe,CAAChB,IAAI,CAAC,EAAE;UAC3BS,IAAI,CAACM,IAAI,CACPX,WAAC,CAACa,oBAAoB,CACpB,GAAG,EACHb,WAAC,CAACc,SAAS,CAACL,EAAE,CAAC,EACfT,WAAC,CAACe,eAAe,CAAC,CAACf,WAAC,CAACgB,aAAa,CAACpB,IAAI,CAACqB,QAAQ,CAAC,CAAC,CACpD,CACF,CAAC;UACDrB,IAAI,CAACqB,QAAQ,GAAGjB,WAAC,CAACc,SAAS,CAACL,EAAE,CAAC;QACjC,CAAC,MAAM;UACLJ,IAAI,CAACM,IAAI,CACPX,WAAC,CAACa,oBAAoB,CACpB,GAAG,EACHb,WAAC,CAACc,SAAS,CAACL,EAAE,CAAC,EAEfb,IACF,CACF,CAAC;UACDO,IAAI,CAACG,CAAC,CAAC,GAAGN,WAAC,CAACc,SAAS,CAACL,EAAE,CAAC;QAC3B;MACF;IACF;IACA,OAAOJ,IAAI;EACb;EAOA,SAASa,mBAAmBA,CAC1BtB,IAAsB,EACtBQ,KAAY,EACkC;IAC9C,MAAMe,YAA4B,GAAG,EAAE;IACvC,MAAMC,OAAmC,GAAG,EAAE;IAE9CxB,IAAI,CAACC,SAAS,CAACwB,OAAO,CAACtB,GAAG,IAAI;MAC5B,IAAIC,WAAC,CAACC,qBAAqB,CAACF,GAAG,CAAC,EAAE;QAChC,MAAMU,EAAE,GAAGL,KAAK,CAACkB,WAAW,CAAC,iBAAiB,CAAC;QAC/CH,YAAY,CAACR,IAAI,CAACX,WAAC,CAACuB,UAAU,CAACd,EAAE,CAAC,CAAC;QACnCW,OAAO,CAACT,IAAI,CAACX,WAAC,CAACuB,UAAU,CAACd,EAAE,CAAC,CAAC;MAChC,CAAC,MAAM;QACLW,OAAO,CAACT,IAAI,CAACZ,GAAG,CAAC;MACnB;IACF,CAAC,CAAC;IACF,OAAO,CAACoB,YAAY,EAAEC,OAAO,CAAC;EAChC;EAEA,OAAO;IACLI,IAAI,EAAE,8BAA8B;IACpCC,QAAQ,EAAEC,uCAAwB;IAElCC,OAAO,EAAE;MACPC,cAAcA,CAACC,IAAI,EAAE;QACnB,IAAI,CAAClC,sBAAsB,CAACkC,IAAI,CAACjC,IAAI,CAAC,EAAE;UACtC;QACF;QACA,MAAM;UAAEA,IAAI;UAAEQ;QAAM,CAAC,GAAGyB,IAAI;QAC5B,MAAMC,YAAY,GAAGD,IAAI,CAACzB,KAAK,CAACM,gCAAgC,CAC9Dd,IAAI,CAACmC,MACP,CAAC;QACD,MAAMC,aAAa,GAAG,EAAE;QACxB,MAAMC,gBAAgB,GAAG/B,eAAe,CAACN,IAAI,EAAEQ,KAAK,CAAC;QACrD,MAAM,CAAC8B,kBAAkB,EAAE/B,IAAI,CAAC,GAAGe,mBAAmB,CAACtB,IAAI,EAAEQ,KAAK,CAAC;QAEnEA,KAAK,CAACO,IAAI,CAAC;UAAEF,EAAE,EAAEqB;QAAa,CAAC,CAAC;QAEhC,IAAIlC,IAAI,CAACmC,MAAM,CAACI,IAAI,KAAK,kBAAkB,EAAE;UAC3C,MAAM;YAAEC,MAAM,EAAEC,QAAQ;YAAEC;UAAS,CAAC,GAAG1C,IAAI,CAACmC,MAAM;UAClD,MAAMQ,YAAY,GAChBV,IAAI,CAACzB,KAAK,CAACM,gCAAgC,CAAC2B,QAAQ,CAAC;UACvDjC,KAAK,CAACO,IAAI,CAAC;YAAEF,EAAE,EAAE8B;UAAa,CAAC,CAAC;UAEhCP,aAAa,CAACrB,IAAI,CAChBX,WAAC,CAACa,oBAAoB,CACpB,GAAG,EACHb,WAAC,CAACc,SAAS,CAACyB,YAAY,CAAC,EAEzBF,QACF,CAAC,EACDrC,WAAC,CAACa,oBAAoB,CACpB,GAAG,EACHb,WAAC,CAACc,SAAS,CAACgB,YAAY,CAAC,EACzB9B,WAAC,CAACwC,gBAAgB,CAACxC,WAAC,CAACc,SAAS,CAACyB,YAAY,CAAC,EAAED,QAAQ,CACxD,CAAC,EACD,GAAGL,gBAAgB,EACnBjC,WAAC,CAACyC,kBAAkB,CAClBzC,WAAC,CAAC0C,YAAY,CAACJ,QAAQ,CAAC,GACpBtC,WAAC,CAACc,SAAS,CAACwB,QAAQ,CAAC,GACrBT,IAAI,CAACzB,KAAK,CAACM,gCAAgC,CAAC4B,QAAQ,CAAC,EACzDJ,kBAAkB,EAClBlC,WAAC,CAAC2C,cAAc,CACd,CACE3C,WAAC,CAAC4C,eAAe,CACf5C,WAAC,CAAC6C,cAAc,CACd7C,WAAC,CAACwC,gBAAgB,CAChBxC,WAAC,CAACc,SAAS,CAACgB,YAAY,CAAC,EACzB9B,WAAC,CAACuB,UAAU,CAAC,MAAM,CACrB,CAAC,EACD,CAACvB,WAAC,CAACc,SAAS,CAACyB,YAAY,CAAC,EAAE,GAAGpC,IAAI,CACrC,CACF,CAAC,CACF,EACD,EACF,CAAC,EACD,KAAK,EACL,KACF,CACF,CAAC;QACH,CAAC,MAAM;UACL6B,aAAa,CAACrB,IAAI,CAChBX,WAAC,CAACa,oBAAoB,CACpB,GAAG,EACHb,WAAC,CAACc,SAAS,CAACgB,YAAY,CAAC,EAEzBlC,IAAI,CAACmC,MACP,CAAC,EACD,GAAGE,gBAAgB,EACnBjC,WAAC,CAACyC,kBAAkB,CAClBzC,WAAC,CAAC0C,YAAY,CAAC9C,IAAI,CAACmC,MAAM,CAAC,GACvB/B,WAAC,CAACc,SAAS,CAAClB,IAAI,CAACmC,MAAM,CAAC,GACxBF,IAAI,CAACzB,KAAK,CAACM,gCAAgC,CAACd,IAAI,CAACmC,MAAM,CAAC,EAC5DG,kBAAkB,EAClBlC,WAAC,CAAC2C,cAAc,CACd,CACE3C,WAAC,CAAC4C,eAAe,CACf5C,WAAC,CAAC6C,cAAc,CAAC7C,WAAC,CAACc,SAAS,CAACgB,YAAY,CAAC,EAAE3B,IAAI,CAClD,CAAC,CACF,EACD,EACF,CAAC,EACD,KAAK,EACL,KACF,CACF,CAAC;QACH;QACA0B,IAAI,CAACiB,WAAW,CAAC9C,WAAC,CAAC+C,kBAAkB,CAACf,aAAa,CAAC,CAAC;MACvD;IACF;EACF,CAAC;AACH,CAAC,CAAC"}