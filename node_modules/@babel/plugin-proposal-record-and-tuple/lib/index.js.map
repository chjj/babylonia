{"version":3,"names":["_helperPluginUtils","require","_pluginSyntaxRecordAndTuple","_core","_helperModuleImports","_helperValidatorOption","v","OptionValidator","_default","exports","default","declare","api","options","assertVersion","polyfillModuleName","validateStringOption","shouldImportPolyfill","validateBooleanOption","importPolyfill","importCaches","WeakMap","getOr","map","key","getDefault","value","get","set","getBuiltIn","name","programPath","t","identifier","Error","cacheKey","isModule","cache","node","Map","localBindingName","addNamed","importedInterop","inherits","syntaxRecordAndTuple","visitor","Program","path","state","RecordExpression","record","object","objectExpression","properties","wrapped","callExpression","replaceWith","TupleExpression","tuple","elements"],"sources":["../src/index.ts"],"sourcesContent":["/*\n ** Copyright 2020 Bloomberg Finance L.P.\n **\n ** Licensed under the MIT License (the \"License\");\n ** you may not use this file except in compliance with the License.\n ** You may obtain a copy of the License at\n **\n **     https://opensource.org/licenses/MIT\n **\n ** Unless required by applicable law or agreed to in writing, software\n ** distributed under the License is distributed on an \"AS IS\" BASIS,\n ** WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n ** See the License for the specific language governing permissions and\n ** limitations under the License.\n */\n\nimport { declare } from \"@babel/helper-plugin-utils\";\nimport syntaxRecordAndTuple from \"@babel/plugin-syntax-record-and-tuple\";\nimport type { Options as SyntaxOptions } from \"@babel/plugin-syntax-record-and-tuple\";\nimport { types as t } from \"@babel/core\";\nimport { addNamed, isModule } from \"@babel/helper-module-imports\";\nimport { OptionValidator } from \"@babel/helper-validator-option\";\nimport type { NodePath } from \"@babel/traverse\";\n\nconst v = new OptionValidator(PACKAGE_JSON.name);\n\nexport interface Options extends SyntaxOptions {\n  polyfillModuleName?: string;\n  importPolyfill?: boolean;\n}\n\ntype State = {\n  programPath: NodePath<t.Program>;\n};\n\n// program -> cacheKey -> localBindingName\ntype Cache = Map<string, string>;\ntype ImportCache = WeakMap<t.Program, Cache>;\n\nexport default declare<State>((api, options: Options) => {\n  api.assertVersion(\n    process.env.BABEL_8_BREAKING && process.env.IS_PUBLISH\n      ? PACKAGE_JSON.version\n      : 7,\n  );\n\n  const polyfillModuleName = v.validateStringOption(\n    \"polyfillModuleName\",\n    options.polyfillModuleName,\n    \"@bloomberg/record-tuple-polyfill\",\n  );\n  const shouldImportPolyfill = v.validateBooleanOption(\n    \"importPolyfill\",\n    options.importPolyfill,\n    !!options.polyfillModuleName,\n  );\n\n  const importCaches: ImportCache = new WeakMap();\n\n  function getOr<K, V>(map: Map<K, V>, key: K, getDefault: () => V): V;\n  function getOr<K extends object, V>(\n    map: WeakMap<K, V>,\n    key: K,\n    getDefault: () => V,\n  ): V;\n  function getOr<K extends object, V>(\n    map: WeakMap<K, V>,\n    key: K,\n    getDefault: () => V,\n  ) {\n    let value = map.get(key);\n    if (!value) map.set(key, (value = getDefault()));\n    return value;\n  }\n\n  function getBuiltIn(\n    name: \"Record\" | \"Tuple\",\n    programPath: NodePath<t.Program>,\n  ) {\n    if (!shouldImportPolyfill) return t.identifier(name);\n    if (!programPath) {\n      throw new Error(\"Internal error: unable to find the Program node.\");\n    }\n\n    const cacheKey = `${name}:${isModule(programPath)}`;\n\n    const cache = getOr(\n      importCaches,\n      programPath.node,\n      () => new Map<string, string>(),\n    );\n    const localBindingName = getOr(cache, cacheKey, () => {\n      return addNamed(programPath, name, polyfillModuleName, {\n        importedInterop: \"uncompiled\",\n      }).name;\n    });\n\n    return t.identifier(localBindingName);\n  }\n\n  return {\n    name: \"proposal-record-and-tuple\",\n    inherits: syntaxRecordAndTuple,\n    visitor: {\n      Program(path, state) {\n        state.programPath = path;\n      },\n      RecordExpression(path, state) {\n        const record = getBuiltIn(\"Record\", state.programPath);\n\n        const object = t.objectExpression(path.node.properties);\n        const wrapped = t.callExpression(record, [object]);\n        path.replaceWith(wrapped);\n      },\n      TupleExpression(path, state) {\n        const tuple = getBuiltIn(\"Tuple\", state.programPath);\n\n        const wrapped = t.callExpression(tuple, path.node.elements);\n        path.replaceWith(wrapped);\n      },\n    },\n  };\n});\n"],"mappings":"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"}